<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
  </head>
  <body>
    <button onclick="Ludbud.oauth('dropbox');">Connect to Dropbox!</button>
    <button onclick="Ludbud.oauth('googledrive');">Connect to Google Drive!</button>
    <button onclick="Ludbud.oauth('remotestorage', document.getElementById('user-address').value);">Connect to your remoteStorage:</button>
    <input id="user-address" placeholder="user@provider.com" value="michiel2@5apps.com" />
    <button onclick="reset();">Disconnect!</button>
  </body>
  <script src="https://raw.githubusercontent.com/mozilla/localforage/master/dist/localforage.min.js"></script>
  <script src="./ludbud.js"></script>
  <script>
    var ludbud;
    Ludbud.setApiCredentials('dropbox', 'cybbbiarf4dkrce');
    Ludbud.setApiCredentials('googledrive', '709507725318-3mt4ke1d4tvkc7ktbjvru3csif4nsk67.apps.googleusercontent.com');
    function getUserDataCredentials(callback) {
      var harvest = Ludbud.fromWindowLocation();
      if (harvest) {
        console.log('setting harvest into localforage, then reloading page', harvest);
        localforage.setItem('userDataCredentials', harvest, function(err) {
          Ludbud.restoreWindowLocation();
          //now the page will be reloaded, after which harvest will be undefined
        });
      } else {
        localforage.getItem('userDataCredentials', callback);
      }
    }
    getUserDataCredentials(function(err, userDataCredentials) {
      if (err) {
        console.log('error getting user data credentials', err);
      } else if (userDataCredentials) {
        ludbud = new Ludbud(userDataCredentials);
        console.log('now we can use the ludbud object to access the user\'s data');
        ludbud.getInfo('/', function(err, info) {
          console.log('getInfo result', err, info);
        });
        ludbud.getBody('/', function(err, body) {
          console.log('getBody result', err, body);
          //see if we can interpret that as utf-8:
          try {
            var fileReader = new FileReader();
            fileReader.addEventListener('loadend', function (evt) {
              console.log('body as utf-8', evt.target.result);
            });
            fileReader.readAsText(new Blob([body], { type: 'text/plain;charset=utf-8'}));
          } catch(e) {
            console.log(e);
          }
        });
        ludbud.getFolder('/', function(err, items) {
          console.log('getFolder result', err, items);
        });
        ludbud.create('/public/notes/test', 'test', 'text/plain', function(err, etag) {
          console.log('C.reate:', err, etag);
          ludbud.getBody('/public/notes/test', function(err, body) {
            console.log('R.ead:', err, body);
            ludbud.update('/public/notes/test', 'test2', 'text/plain', etag, function(err, etag2) {
              console.log('U.pdate:', err, etag2);
              ludbud.update('/public/notes/test', 'test2', 'text/plain', etag2, function(err) {
                console.log('D.elete:', err);
              });
            });
          });
        });
      } else {
        console.log('No user data credentials yet. Please click one of the buttons');
      }
    });
    function reset() {
      localforage.clear(function() {
        window.location = window.location.href;
      });
    }
  </script>
</html>
